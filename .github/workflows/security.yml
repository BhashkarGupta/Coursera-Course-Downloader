name: security

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: "17 3 * * 1" # weekly

concurrency:
  group: security-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  codeql:
    name: CodeQL (SAST)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read
      packages: read

    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: javascript-typescript
          build-mode: none
          queries: security-extended,security-and-quality

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4


  gitleaks:
    name: Secrets Scan (Gitleaks)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


  semgrep:
    name: Semgrep (SAST rules)
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Semgrep scan
        uses: returntocorp/semgrep-action@v1
        with:
          config: p/security-audit


  extension-guardrails:
    name: Extension Guardrails (Heuristics)
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Print manifest.json
        shell: bash
        run: |
          set -euo pipefail

          if [ -f "manifest.json" ]; then
            echo "=== manifest.json ==="
            cat manifest.json
          elif [ -f "src/manifest.json" ]; then
            echo "=== src/manifest.json ==="
            cat src/manifest.json
          else
            echo "No manifest.json found at repo root or src/. Check paths."
          fi

      - name: Heuristic suspicious-pattern scan
        shell: bash
        run: |
          set -euo pipefail

          echo "=== Heuristic grep ==="

          # Remote code / execution / obfuscation
          grep -RIn --exclude-dir=.git \
            -e "eval(" \
            -e "new Function" \
            -e "WebAssembly" \
            -e "atob(" \
            -e "fromCharCode" \
            -e "base64" \
            . || true

          # Network exfiltration / C2 indicators
          grep -RIn --exclude-dir=.git \
            -e "fetch(" \
            -e "XMLHttpRequest" \
            -e "WebSocket" \
            -e "wss\?://" \
            -e "http://" \
            -e "https://" \
            -e "pastebin" \
            -e "discord" \
            -e "webhook" \
            . || true

          # Crypto-miner signals
          grep -RIn --exclude-dir=.git \
            -e "stratum\+tcp" \
            -e "hashrate" \
            -e "xmrig" \
            -e "miner" \
            -e "crypto" \
            . || true

          # Chrome extension red flags
          grep -RIn --exclude-dir=.git \
            -e "chrome\.scripting\.executeScript" \
            -e "nativeMessaging" \
            -e "externally_connectable" \
            -e "<all_urls>" \
            . || true
